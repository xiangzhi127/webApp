var PROTOCOL = window.location.protocol == "http:" ? "http:" : "https:";
if ((window.location.protocol == "http:" || window.location.protocol == "https:") && !window.FTA)
    document.write("<scri" + 'pt type="text/javascript" src="' + PROTOCOL + '//img4.tuniucdn.com/w/j/20160527/common/tac.js,common/ga.js"></scri' + "pt>");
if (/MicroMessenger/i.test(navigator.userAgent)) {
    document.write("<scri" + 'pt type="text/javascript" src="' + PROTOCOL + '//img2.tuniucdn.com/site/wap/js/new/weixin/wx-share.js"></scri' + "pt>")
}
if (/qq/i.test(navigator.userAgent) && /android/i.test(navigator.userAgent)) {
    document.write("<scr" + 'ipt src="' + PROTOCOL + '//jsapi.qq.com/get?api=app.getGeoLocation"><' + "/script>")
}
!function(t, e) {
    var i = {
        init: function() {
            this._initConstant();
            this._initAppCookie();
            this._hideAppHeader();
            this._initRetina();
            this._initAutoGPS();
            this._initUserGPS();
            this._initAppLinks();
            this._initTelAndP()
        },
        _initConstant: function() {
            this.USER_GPS = "userGPS";
            this.AUTO_GPS = "autoGPS";
            this.LT = "lastAlertTime";
            this.AI = 108e5
        },
        _initAppCookie: function() {
            var e = decodeURIComponent(t.location.hash.slice(1));
            var i = e.match(/deviceType=\d+/);
            if (i && i[0]) {
                document.cookie = i[0] + ";path=/;domain=tuniu.com"
            }
            this.isApp = document.cookie.indexOf("deviceType") != -1 || !!localStorage.getItem("zipLocation");
            this.isFinanceApp = function() {
                var t = document.cookie.match(new RegExp("(^| )clientType=([^;]*)(;|$)"));
                if (t && t[2]) {
                    if (",50001,50004,".indexOf("," + t[2] + ",") != -1) {
                        return true
                    }
                }
                return false
            }();
            this.isHybrid = t.location.protocol.indexOf("http") == -1;
            if (this.isApp && document.documentElement) {
                document.documentElement.classList.add("app")
            }
            if (localStorage.getItem("appVersion")) {
                this.AppVersion = localStorage.getItem("appVersion")
            } else {
                var a = document.cookie.match(/appVersion=([\.|\d]+)/);
                if (a && a[1]) {
                    this.AppVersion = a[1]
                } else {
                    this.AppVersion = null
                }
            }
        },
        _hideAppHeader: function() {
            if (i.isApp) {
                var t = document.getElementsByTagName("header")[0];
                if (t) {
                    t.style.display = "none"
                }
                var e = document.getElementById("index");
                if (e) {
                    e.style.paddingTop = "0px"
                }
                var a = document.getElementById("content");
                if (a) {
                    a.style.paddingTop = "0px"
                }
                var n = document.querySelector(".wrapper");
                if (n) {
                    n.style.marginTop = "0px";
                    n.style.paddingTop = "0px"
                }
                var o = document.querySelector(".main_count");
                if (o) {
                    o.style.paddingTop = 0
                }
                var r = document.querySelector(".app-header");
                if (r) {
                    r.style.display = "none"
                }
            }
        },
        _initRetina: function() {
            if (t.devicePixelRatio && t.devicePixelRatio >= 2) {
                var e = document.createElement("div");
                e.style.border = ".5px solid transparent";
                document.body.appendChild(e);
                if (e.offsetHeight == 1) {
                    document.querySelector("html").classList.add("hairlines")
                }
                document.body.removeChild(e)
            }
        },
        _initUserGPS: function() {
            var t = document.getElementById(this.USER_GPS);
            var e = function(t) {
                return typeof t == "string" && t.indexOf("code") > -1 && t.indexOf("name") > -1 && t.indexOf("letter") > -1
            };
            if (t && t.value && e(t.value)) {
                var i = JSON.parse(t.value);
                var a = location.hash.indexOf("autoJump") == -1;
                this.setUserGps(i, a)
            } else {
                var n = localStorage.getItem(this.USER_GPS);
                e(n) ? this.userGPS = n == null ? n : JSON.parse(n) : localStorage.removeItem(this.USER_GPS)
            }
        },
        _initAutoGPS: function() {
            var t = localStorage.getItem(this.AUTO_GPS);
            this.location = t == null ? t : JSON.parse(t)
        },
        _initAppLinks: function() {
            var e = this;
            document.body.addEventListener("click", function(i) {
                var a = i.target;
                var n = [];
                while (a && a.nodeName != "BODY") {
                    if (a.nodeName == "A") {
                        n.push(a)
                    }
                    a = a.parentNode
                }
                for (var o = 0; o < n.length; o++) {
                    var r = n[o].getAttribute("data-appurl") || "";
                    var s = n[o].getAttribute("data-pst") || "";
                    var c = n[o].getAttribute("href");
                    var d;
                    r = r.trim();
                    if (r.indexOf("tuniuapp://") == 0 && e.isApp && !e.isFinanceApp) {
                        t.location.href = r;
                        i.preventDefault();
                        break
                    }
                    if (s) {
                        var u = c.split("#");
                        if (u[0].indexOf("?") == -1) {
                            d = u[0] + "?" + s + "#" + u.slice(1).join("#")
                        } else {
                            d = u[0] + "&" + s + "#" + u.slice(1).join("#")
                        }
                        t.location.href = d;
                        i.preventDefault();
                        break
                    }
                }
            }, false)
        },
        getPFromURL: function() {
            var e = t.location.hash.slice(1).split("&").concat(t.location.search.slice(1).split("&"));
            var i = {};
            for (var a = 0; a < e.length; a++) {
                var n = e[a].split("=");
                i[n[0]] = n[1]
            }
            return i.p
        },
        getHost: function() {
            var e = t.location.host;
            var i = t.location.protocol;
            if (e.indexOf("tuniu.com") != -1 || e.indexOf("tuniu.org") != -1) {
                if (e.indexOf("dynamic") != 0) {
                    e = "dynamic." + e
                }
                e = i + "//" + e
            } else {
                e = i + "//dynamic.m.tuniu.com"
            }
            return e
        },
        replaceProtocol: function(t) {
            return t ? t.replace(/^http:|^https:/g, PROTOCOL) : ""
        },
        convertProtocol: function(t) {
            var e = t, i = JSON.stringify(t), a;
            if (location.protocol == "https:") {
                a = i.replace(/http:/g, "https:");
                e = JSON.parse(a)
            }
            return e
        },
        _initTelAndP: function() {
            var t = this;
            var i = t.getHost();
            function a(t) {
                return document.getElementById(t)
            }
            t.p = t.getPFromURL();
            var n = {
                partner: {
                    p: t.getPFromURL() || "",
                    referer: encodeURIComponent(document.referrer)
                }
            };
            if (e && e.phone) {
                n.phone = ""
            }
            var o = new XMLHttpRequest;
            o.open("GET", i + "/m2015/global/index?data=" + encodeURIComponent(JSON.stringify(n)));
            o.onreadystatechange = function() {
                if (o.readyState == 4 && o.status == 200) {
                    var e = JSON.parse(o.responseText);
                    if (e.success) {
                        t.gaStatus.p = true;
                        t.tryTa();
                        e = e.data;
                        var i = e.phone;
                        if (i) {
                            localStorage.setItem("400phone", i);
                            var n = new Date;
                            n.setDate(n.getDate() + 15);
                            document.cookie = "400phone=" + i + ";path=/;domain=tuniu.com;expires=" + n.toUTCString();
                            t.phone = i;
                            for (var r = 0; r < t.phoneListeners.length; r++) {
                                t.phoneListeners[r](t.phone)
                            }
                        }
                        if (i && a("telConsult")) {
                            a("telConsult").href = "tel:" + i
                        }
                    }
                }
            }
            ;
            o.withCredentials = true;
            o.send(null )
        },
        _startTa: function() {
            if (typeof _tat == "undefined") {
                return
            }
            var t = _tat.getTracker();
            t.setPageName(this.gaStatus.taPageName);
            t.addOrganic("www.so.com", "u");
            t.addOrganic("www.so.com", "q");
            t.addOrganic("so.360.cn", "u");
            t.addOrganic("so.360.cn", "q");
            t.addOrganic("baidu.com", "w");
            t.addOrganic("baidu.com", "q1");
            t.addOrganic("baidu.com", "q2");
            t.addOrganic("baidu.com", "q3");
            t.addOrganic("baidu.com", "q4");
            t.addOrganic("baidu.com", "q5");
            t.addOrganic("baidu.com", "q6");
            t.addOrganic("m.so.com", "q");
            t.addOrganic("m.sogou.com", "keyword");
            t.addOrganic("wap.sogou.com", "keyword");
            t.addOrganic("wap.soso.com", "key");
            t.addOrganic("m.yisou.com", "q");
            t.addOrganic("m.sm.cn", "q");
            t.addOrganic("sm.cn", "q");
            t.trackPageView();
            t.enableLinkTracking()
        },
        tryTa: function() {
            var t = this;
            if (t.gaStatus.p && t.gaStatus.taPageName) {
                t._startTa()
            }
        },
        _startGa: function() {
            if (typeof _gaq == "undefined") {
                return
            }
            _gaq = _gaq || [];
            var t = t || {
                isWebview: (document.cookie.indexOf("deviceType") > -1) + ""
            };
            var e = this.gaStatus.gaPageName;
            _gaq.push(["_setAllowHash", false]);
            _gaq.push(["_setAllowAnchor", true]);
            _gaq.push(["_addOrganic", "baidu", "wd"]);
            _gaq.push(["_addOrganic", "baidu", "word"]);
            _gaq.push(["_addOrganic", "google", "q"]);
            _gaq.push(["_addOrganic", "118114", "kw"]);
            _gaq.push(["_addOrganic", "bing", "q"]);
            _gaq.push(["_addOrganic", "soso", "w"]);
            _gaq.push(["_addOrganic", "youdao", "q"]);
            _gaq.push(["_addOrganic", "sogou", "query"]);
            _gaq.push(["_addOrganic", "360", "q"]);
            _gaq.push(["_addOrganic", "baidu", "w"]);
            _gaq.push(["_addOrganic", "baidu", "q1"]);
            _gaq.push(["_addOrganic", "baidu", "q2"]);
            _gaq.push(["_addOrganic", "baidu", "q3"]);
            _gaq.push(["_addOrganic", "baidu", "q4"]);
            _gaq.push(["_addOrganic", "baidu", "q5"]);
            _gaq.push(["_addOrganic", "baidu", "q6"]);
            _gaq.push(["_addOrganic", "baidu", "q6"]);
            _gaq.push(["_addOrganic", "m.so.com", "q"]);
            _gaq.push(["_addOrganic", "m.sogou.com", "keyword"]);
            _gaq.push(["_addOrganic", "wap.sogou.com", "keyword"]);
            _gaq.push(["_addOrganic", "wap.soso.com", "key"]);
            _gaq.push(["_addOrganic", "m.yisou.com", "q"]);
            _gaq.push(["_addOrganic", "m.sm.cn", "q"]);
            _gaq.push(["_addOrganic", "sm.cn", "q"]);
            _gaq.push(["_setDomainName", "tuniu.com"]);
            _gaq.push(["_setCustomVar", 5, "UIWebview", t.isWebview, 3]);
            _gaq.push(["_setAccount", "UA-4782081-5"]);
            _gaq.push(["_trackPageview", e])
        },
        tryGa: function() {
            var t = this;
            if (t.gaStatus.loaded && t.gaStatus.gaPageName) {
                t._startGa()
            }
        },
        versionCmp: function(t, e) {
            if (!t || !e) {
                return -1
            }
            if (t == e)
                return 0;
            var i = t.split(".")
              , a = e.split(".");
            return i[0] == a[0] ? this.versionCmp(i.slice(1).join("."), a.slice(1).join(".")) : +i[0] > +a[0] ? 1 : -1
        },
        setAutoGps: function(t) {
            this.autoGPS = t;
            localStorage.setItem(this.AUTO_GPS, JSON.stringify(t));
            if (i.autoGPSListeners) {
                for (var e = 0; e < i.autoGPSListeners.length; e++) {
                    i.autoGPSListeners[e](t)
                }
            }
        },
        addAutoGPSListener: function(t) {
            this.autoGPSListeners.push(t);
            if (this.autoGPS) {
                t(this.autoGPS)
            }
        },
        setUserGps: function(t, e) {
            var i = typeof t === "string" ? JSON.parse(t) : t;
            if (e) {
                this.userGPS = i;
                localStorage.setItem(this.USER_GPS, JSON.stringify(i))
            } else {
                var a = localStorage.getItem(this.USER_GPS);
                this.userGPS = a == null ? a : JSON.parse(a)
            }
            for (var n = 0; n < this.userGPSListeners.length; n++) {
                this.userGPSListeners[n](i)
            }
        },
        _setLastAlertTime: function() {
            localStorage.setItem(this.LT, (new Date).getTime())
        },
        afterGetPosition: function(t, i) {
            if (!t) {
                return
            }
            t.lat = i.lat || "";
            t.lng = i.lng || "";
            this.lastLocation = this.location;
            var a = this.location = t
              , n = !a.code ? null : {
                name: a.name,
                code: a.code,
                letter: a.letter
            }
              , o = !a.belongCityCode ? null : {
                name: a.belongCityName,
                code: a.belongCityCode,
                letter: a.belongCityLetter
            }
              , r = o || n;
            if (r == null ) {
                return
            }
            r.lat = i.lat || "";
            r.lng = i.lng || "";
            this.setAutoGps(r);
            this.storedMc = o;
            this.storedPc = n;
            if (e.jumpWhenLocationOver) {
                this.showHitByPosition(this._reloadCity)
            } else {
                this.checkCityChanged()
            }
            return r
        },
        checkCityChanged: function(t) {
            var i = this.cityChangedListens;
            t && i.push(t);
            if (e.hasJumpCallback && i.length > 0) {
                this.showHitByPosition(function(t) {
                    for (var e = 0; e < i.length; e++) {
                        i[e](t)
                    }
                })
            }
        },
        showHitByPosition: function(t, i) {
            i = i || function() {}
            ;
            var a = this.storedMc;
            var n = this.storedPc;
            var o = this;
            if (null == n || this.hasPosition) {
                return
            }
            this.hasPosition = true;
            var r = function() {
                var t = localStorage.getItem(o.LT);
                return t && new Date - new Date(+t) < o.AI
            };
            if (r() && this.userGPS != null ) {
                return
            }
            var s = this.userGPS || this.lastLocation;
            var c = a || n;
            if (null == s) {
                if (c.name != "上海") {
                    t(c, e.jumpWhenLocationOver ? "#autoJump" : 0)
                }
                return
            }
            var d = function(t, e) {
                return null != t && null != e && t.name === e.name && t.code === e.code && t.letter == e.letter
            };
            if (d(c, s)) {
                return
            }
            var u = function(t) {
                o.setUserGps(t, true);
                o._setLastAlertTime()
            };
            if (d(c, n)) {
                var l = "检测到您所在的城市发生了变化，当前城市为" + c.name + "，是否切换到当前城市？"
            } else {
                l = "根据您当前的位置" + n.name + "，我们向您推荐较近的可预订城市" + c.name + "，是否切换？"
            }
            o._showDialog(l, function() {
                u(c);
                t.call(o, c)
            }, function() {
                u(s);
                i.call(o, s)
            })
        },
        _reloadCity: function(t, i) {
            if (!t || !t.letter) {
                return
            }
            var a = e.jumpWhenLocationOver;
            a = a.replace(/\{cityLetter\}/g, t.letter).replace(/\{cityCode\}/g, t.code).replace(/\{cityName\}/g, t.name) + (i || "");
            history.replaceState(null , null , a);
            location.reload()
        },
        _showDialog: function(t, e, i) {
            var a = "切换城市提示";
            function n(t) {
                var e = document.createElement("div");
                e.style.cssText = t;
                document.body.appendChild(e);
                return e
            }
            var o = n("position:fixed;top:0;width: 100%;height: 100%;background-color:rgba(0,0,0,0.56);z-index: 999;");
            var r = n("border-radius:8px;position: fixed;left: 13%;top:30%;width: 74%;z-index: 999;background-color:rgba(256,256,256,1);text-align:center;");
            r.innerHTML = '<div style="color:#333;padding-top:7.4%;font-weight:bold;font-size: 1.8rem;text-align: center;">' + a + '</div>                            <div style="padding:7.4% 5.5%;font-size:1.5rem;color:#666;">                                <span>' + t + '</span>                            </div>                            <div style="border-top: 1px solid rgb(212,212,212);font-size:1.8rem;color:#037AFF;line-height: 2.222;">                                <div class="J-ok" style="width: 50%;float: left;">切换</div>                                <div class="J-cancel" style="width: 49%;border-left: 1px solid rgb(212,212,212);float: right;">取消</div>                            </div>';
            r.addEventListener("click", function(t) {
                var a = t.target.className;
                var n = ["J-ok", "J-cancel"].indexOf(a);
                if (n == -1) {
                    return
                }
                r.style.display = o.style.display = "none";
                n ? i() : e()
            })
        },
        initWebviewBridge: function() {
            if (this.webviewBridgeInited) {
                return
            }
            WebViewJavascriptBridge.init(function(t, e) {});
            this.webviewBridgeInited = true
        },
        webviewBridgeReady: function(e) {
            var i = this;
            if (t.WebViewJavascriptBridge) {
                i.initWebviewBridge();
                e(WebViewJavascriptBridge)
            } else {
                document.addEventListener("WebViewJavascriptBridgeReady", function() {
                    i.initWebviewBridge();
                    e(WebViewJavascriptBridge)
                }, false)
            }
        },
        gaStatus: {
            p: "",
            taPageName: "",
            gaPageName: "",
            loaded: false
        },
        phoneListeners: [],
        userGPSListeners: [],
        autoGPSListeners: [],
        cityChangedListens: []
    };
    i.init();
    function a(a, n, o, r) {
        var s;
        function c(t) {
            if (!a.trim()) {
                i.gaStatus.taPageName = n;
                i.tryTa()
            } else {
                if (t) {
                    i.gaStatus.taPageName = a.replace("{city}", t);
                    i.tryTa()
                }
            }
            if (!o.trim()) {
                i.gaStatus.gaPageName = r;
                i.tryGa()
            } else {
                if (t) {
                    i.gaStatus.gaPageName = r.replace("{city}", t);
                    i.tryGa()
                }
            }
        }
        t.addEventListener("load", function() {
            i.gaStatus.loaded = true;
            i.tryGa();
            if (t.criteo_q) {
                u()
            }
        }, false);
        if (i.versionCmp(i.AppVersion, "7.1.1") >= 0) {
            i.webviewBridgeReady(function(t) {
                t.callHandler("getGPS", {}, function(t) {
                    s = t.orderCityName || t.name;
                    c(s)
                })
            });
            return
        }
        var d = localStorage.getItem(i.USER_GPS) || localStorage.getItem(i.AUTO_GPS) || localStorage.getItem("zipLocation");
        if (d) {
            s = JSON.parse(d).name || JSON.parse(d).cityName || "上海";
            c(s)
        }
        function u() {
            var t = document.createElement("script");
            t.type = "text/javascript";
            t.src = "//static.criteo.net/js/ld/ld.js";
            document.querySelector("head").appendChild(t)
        }
        function l(t) {
            t = t || "";
            var e = new XMLHttpRequest;
            e.open("GET", "/m2015/global/index?data=" + encodeURIComponent(JSON.stringify({
                location: t || ""
            })));
            e.onreadystatechange = function() {
                if (e.readyState == 4 && e.status == 200) {
                    var a = JSON.parse(e.responseText);
                    if (a.success) {
                        a = a.data;
                        var n = i.afterGetPosition(a.location, t);
                        if (!s && n && n.name) {
                            try {
                                c(n.name)
                            } catch (o) {
                                console.debug(o)
                            }
                        }
                    }
                }
            }
            ;
            e.withCredentials = true;
            e.send(null )
        }
        if (e && e.location) {
            var g = localStorage.getItem("zipLocation");
            if ((e.justLocationIP || /19007/.test(document.cookie)) && t.G && t.G.isApp) {
                l();
                return
            }
            if (i.isApp && g && t.G && t.G.isHybrid) {
                g = JSON.parse(g);
                if (g.lat && g.lng) {
                    l({
                        lat: g.lat,
                        lng: g.lng
                    });
                    return
                }
            }
            var p = setTimeout(function() {
                l();
                p = null
            }, 5e3);
            var h = function(t) {
                if (p) {
                    clearTimeout(p);
                    l(t)
                }
            };
            if (t.browser && /qq/i.test(navigator.userAgent) && /android/i.test(navigator.userAgent)) {
                browser.app.getGeoLocation(function(t) {
                    h({
                        lat: t.latitude,
                        lng: t.longitude
                    })
                }, function() {
                    h()
                })
            } else {
                navigator.geolocation.getCurrentPosition(function(t) {
                    h({
                        lat: t.coords.latitude,
                        lng: t.coords.longitude
                    })
                }, function(t) {
                    h()
                })
            }
        } else {
            l();
            return
        }
    }
    t.COLLECT = a;
    t.G = i
}(window, window.globalAjaxControl);
